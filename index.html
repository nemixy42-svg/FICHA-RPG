<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha RPG - XP Progressivo</title>
    <style>
        :root {
            --bg: #0d1117; --card: #161b22; --primary: #58a6ff; --text: #c9d1d9; --accent: #238636; --border: #30363d; --save: #1f6feb;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .wrapper { width: 100%; max-width: 800px; background: var(--card); border-radius: 12px; padding: 25px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); border: 1px solid var(--border); }
        h2 { text-align: center; color: var(--primary); margin: 10px 0 25px; text-transform: uppercase; letter-spacing: 3px; font-size: 1.8em; }
        
        .field-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.75em; color: #8b949e; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 10px; background: #010409; border: 1px solid var(--border); color: white; border-radius: 6px; box-sizing: border-box; font-size: 1em; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin: 15px 0; }
        .stat-box { background: #0d1117; padding: 12px; border-radius: 10px; border: 1px solid var(--border); text-align: center; }
        .stat-box.total { border-bottom: 4px solid var(--accent); }
        .stat-num { font-size: 1.5em; font-weight: bold; display: block; color: #fff; }
        .stat-label { font-size: 0.6em; color: #8b949e; text-transform: uppercase; }

        .xp-section { background: #0d1117; padding: 15px; border-radius: 10px; border: 1px solid #30363d; margin-bottom: 20px; }
        .xp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .lvl-badge { background: var(--primary); color: #000; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 1.2em; }
        
        .xp-calc-box { display: flex; gap: 10px; }
        .xp-calc-box input { flex: 3; font-size: 1.2em; border-color: var(--primary); text-align: center; }
        .btn-calc { flex: 1; background: var(--primary); color: black; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }

        .equip-card { background: #0d1117; border: 1px solid var(--border); border-radius: 10px; padding: 12px; margin-bottom: 15px; }
        .equip-header { display: grid; grid-template-columns: 3fr 1fr 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .equip-header input { padding: 8px; font-size: 0.9em; text-align: center; }
        .equip-effect { font-size: 0.85em; background: #161b22 !important; border: 1px dashed #444 !important; color: #aaa; }

        .xp-bar-container { background: #30363d; height: 12px; border-radius: 6px; margin-top: 15px; overflow: hidden; }
        .xp-bar-fill { background: linear-gradient(90deg, #238636, #2ea043); height: 100%; width: 0%; transition: width 0.5s; }

        .section-title { border-left: 4px solid var(--primary); padding-left: 10px; margin: 30px 0 10px; color: var(--primary); font-size: 0.9em; font-weight: bold; text-transform: uppercase; }
        .skill-card { background: #0d1117; padding: 12px; border-radius: 8px; margin-top: 8px; border: 1px solid var(--border); border-left: 4px solid var(--primary); }
        .skill-name { font-weight: bold; color: var(--primary); font-size: 0.95em; }
        .skill-desc { font-size: 0.85em; color: #8b949e; margin-top: 5px; }

        .backup-btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .btn-action { border: none; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; font-size: 0.8em; }
    </style>
</head>
<body>

<div class="wrapper">
    <h2>üõ°Ô∏è FICHA DE BATALHA</h2>

    <div class="backup-btns">
        <button class="btn-action" style="background:var(--save)" onclick="exportarFicha()">üì• SALVAR</button>
        <button class="btn-action" style="background:var(--accent)" onclick="document.getElementById('file-input').click()">üì§ CARREGAR</button>
        <button class="btn-action" style="background:#f85149" onclick="resetar()">‚ö†Ô∏è RESET</button>
        <input type="file" id="file-input" style="display:none" onchange="importarFicha(event)">
    </div>

    <div class="field-group">
        <label>üåÄ Participante</label>
        <input type="text" id="part-name" oninput="salvar()">
    </div>

    <div class="field-group">
        <label>üòé Classe</label>
        <select id="char-select" onchange="salvar()">
            <option value="DRUZION">DRUZION (Curandeiro)</option>
            <option value="GUILBERT">GUILBERT (Arqueiro)</option>
            <option value="MELKYOR">MELKYOR (Mago)</option>
            <option value="SCAR">SCAR (Guerreiro)</option>
            <option value="DEWPEE">DEWPEE (Pistoleiro)</option>
        </select>
    </div>

    <!-- SISTEMA DE XP CALCULADORA -->
    <div class="xp-section">
        <div class="xp-header">
            <label>üî∫ N√≠vel Calculado</label>
            <div class="lvl-badge" id="lvl-display">1</div>
        </div>
        <label>‚ú® XP TOTAL (Aceita somas ex: 1500+500)</label>
        <div class="xp-calc-box">
            <input type="text" id="xp-input" value="0" placeholder="Ex: 1000+500 ou 1500-200">
            <button class="btn-calc" onclick="calcularXP()">OK</button>
        </div>
        
        <div class="xp-bar-container"><div class="xp-bar-fill" id="xp-fill"></div></div>
        <div style="display:flex; justify-content: space-between; font-size: 0.8em; margin-top: 8px;">
            <span>No N√≠vel: <b id="xp-atual-no-lvl">0</b> / <span id="xp-req-prox">500</span></span>
            <span>XP Total: <b id="xp-total-display">0</b></span>
        </div>
    </div>

    <div class="section-title">üìä Atributos</div>
    <div class="stats-grid">
        <div class="stat-box total"><span class="stat-label">üíñ Vida</span><span class="stat-num" id="total-hp">0</span></div>
        <div class="stat-box total"><span class="stat-label">üëäüèΩ Dano</span><span class="stat-num" id="total-dmg">0</span></div>
        <div class="stat-box"><span class="stat-label">üõ°Ô∏è Escudo</span><span class="stat-num" id="total-shd">0</span></div>
        <div class="stat-box"><span class="stat-label">üí∞ Ouro</span><input type="number" id="ouro" oninput="salvar()"></div>
        <div class="stat-box"><span class="stat-label">üíé Diam.</span><input type="number" id="diamante" oninput="salvar()"></div>
    </div>

    <div class="section-title">üî∂ Equipamentos</div>
    <div id="equip-container"></div>

    <div class="section-title">üéí Mochila</div>
    <textarea id="mochila" oninput="salvar()"></textarea>

    <div class="section-title">üí´ Habilidades</div>
    <div id="skills-container"></div>
</div>

<script>
    const data = {
        chars: {
            DRUZION: { hp: 90, dmg: 4, p: "AURA VERDE", pd: "Cura aliado: vida recuperada = seu dano total." },
            GUILBERT: { hp: 80, dmg: 8, p: "RESPEITO", pd: "Com 2 aliados ou menos, voc√™ n√£o √© alvo." },
            MELKYOR: { hp: 70, dmg: 12, p: "MANAMUNDO", pd: "Causa +10% de dano para cada aliado." },
            SCAR: { hp: 60, dmg: 16, p: "CONTRAGOLPE", pd: "Dano par recebido causa 20% de volta." },
            DEWPEE: { hp: 50, dmg: 20, p: "MUNI√á√ÉO EXPLOSIVA", pd: "Causa 20% do dano em √°rea nos inimigos." }
        },
        skills: [
            { lvl: 1, DRUZION: "REPOUSO / ALVO", GUILBERT: "CHUVA DE FLECHAS", MELKYOR: "VENENO M√ÅGICO", SCAR: "L√ÇMINA VAMP√çRICA", DEWPEE: "RECARREGAR" },
            { lvl: 4, DRUZION: "CURA FRACA", GUILBERT: "PRISMA ARCANO", MELKYOR: "RECARGA DE ENERGIA", SCAR: "UNI√ÉO AMISTOSA", DEWPEE: "TIRO DUPLO" },
            { lvl: 7, DRUZION: "CONFUS√ÉO", GUILBERT: "GRITO DE GUERRA", MELKYOR: "CORROS√ÉO", SCAR: "MALDI√á√ÉO", DEWPEE: "BALA DE PRECIS√ÉO" },
            { lvl: 10, DRUZION: "DUETO", GUILBERT: "L√ÇMINA GIRAT√ìRIA", MELKYOR: "DUALIDADE", SCAR: "ARCO-√çRIS", DEWPEE: "RAJADA FREN√âTICA" }
        ]
    };

    let xpTotalGlobal = 0;

    const equipContainer = document.getElementById('equip-container');
    for(let i=1; i<=4; i++) {
        equipContainer.innerHTML += `
            <div class="equip-card">
                <div class="equip-header">
                    <input type="text" id="eq_n_${i}" placeholder="Nome" oninput="salvar()">
                    <input type="number" id="eq_h_${i}" placeholder="+HP" oninput="salvar()">
                    <input type="number" id="eq_d_${i}" placeholder="+DMG" oninput="salvar()">
                    <input type="number" id="eq_s_${i}" placeholder="+ESC" oninput="salvar()">
                </div>
                <input type="text" class="equip-effect" id="eq_e_${i}" placeholder="Efeito..." oninput="salvar()">
            </div>`;
    }

    // === L√ìGICA DE C√ÅLCULO DE XP E N√çVEL ===
    function calcularXP() {
        const input = document.getElementById('xp-input').value;
        try {
            // Remove espa√ßos e calcula a express√£o (ex: 1500+500 vira 2000)
            const resultado = Function('"use strict";return (' + input + ')')();
            xpTotalGlobal = Math.max(0, resultado);
            document.getElementById('xp-input').value = xpTotalGlobal;
            salvar();
        } catch (e) {
            alert("Erro no c√°lculo! Use apenas n√∫meros, + ou -");
        }
    }

    function calcularNivel(xpTotal) {
        let lvl = 1;
        let xpAcumuladoParaLvlAnterior = 0;
        
        while (true) {
            let xpParaProx = lvl * 500;
            if (xpTotal >= xpAcumuladoParaLvlAnterior + xpParaProx) {
                xpAcumuladoParaLvlAnterior += xpParaProx;
                lvl++;
            } else {
                break;
            }
        }
        
        let xpNoNivelAtual = xpTotal - xpAcumuladoParaLvlAnterior;
        let xpNecessarioParaUp = lvl * 500;

        return { lvl, xpNoNivelAtual, xpNecessarioParaUp };
    }

    function salvar() {
        const estado = {
            part: document.getElementById('part-name').value,
            char: document.getElementById('char-select').value,
            xpTotal: xpTotalGlobal,
            ouro: document.getElementById('ouro').value,
            diamante: document.getElementById('diamante').value,
            mochila: document.getElementById('mochila').value,
            equips: []
        };
        for(let i=1; i<=4; i++) {
            estado.equips.push({
                n: document.getElementById(`eq_n_${i}`).value,
                h: parseInt(document.getElementById(`eq_h_${i}`).value) || 0,
                d: parseInt(document.getElementById(`eq_d_${i}`).value) || 0,
                s: parseInt(document.getElementById(`eq_s_${i}`).value) || 0,
                e: document.getElementById(`eq_e_${i}`).value
            });
        }
        localStorage.setItem('ficha_rpg_v7', JSON.stringify(estado));
        atualizarUI(estado);
    }

    function atualizarUI(s) {
        const charBase = data.chars[s.char];
        const progresso = calcularNivel(s.xpTotal);
        
        // Atributos
        let bH = 0, bD = 0, bS = 0;
        s.equips.forEach(e => { bH += e.h; bD += e.d; bS += e.s; });
        document.getElementById('total-hp').innerText = charBase.hp + bH;
        document.getElementById('total-dmg').innerText = charBase.dmg + bD;
        document.getElementById('total-shd').innerText = bS;

        // XP UI
        document.getElementById('lvl-display').innerText = progresso.lvl;
        document.getElementById('xp-atual-no-lvl').innerText = progresso.xpNoNivelAtual;
        document.getElementById('xp-req-prox').innerText = progresso.xpNecessarioParaUp;
        document.getElementById('xp-total-display').innerText = s.xpTotal;
        document.getElementById('xp-fill').style.width = (progresso.xpNoNivelAtual / progresso.xpNecessarioParaUp * 100) + "%";

        // Habilidades
        const container = document.getElementById('skills-container');
        container.innerHTML = `<div class="skill-card" style="border-left-color: #f1e05a"><b>‚ú® PASSIVA: ${charBase.p}</b><br><small>${charBase.pd}</small></div>`;
        data.skills.forEach(sk => {
            if(progresso.lvl >= sk.lvl) {
                container.innerHTML += `<div class="skill-card"><b>‚öîÔ∏è ${sk[s.char]}</b> <small>(Lvl ${sk.lvl})</small></div>`;
            }
        });
    }

    function exportarFicha() {
        const estado = JSON.parse(localStorage.getItem('ficha_rpg_v7'));
        const blob = new Blob([JSON.stringify(estado, null, 2)], {type : 'application/json'});
        const dl = document.createElement('a');
        dl.href = URL.createObjectURL(blob);
        dl.download = `ficha_${estado.part || 'rpg'}.json`;
        dl.click();
    }

    function importarFicha(event) {
        const reader = new FileReader();
        reader.onload = e => {
            const s = JSON.parse(e.target.result);
            xpTotalGlobal = s.xpTotal || 0;
            document.getElementById('part-name').value = s.part || "";
            document.getElementById('char-select').value = s.char || "DRUZION";
            document.getElementById('xp-input').value = xpTotalGlobal;
            document.getElementById('ouro').value = s.ouro || 0;
            document.getElementById('diamante').value = s.diamante || 0;
            document.getElementById('mochila').value = s.mochila || "";
            s.equips.forEach((e, i) => {
                document.getElementById(`eq_n_${i+1}`).value = e.n || "";
                document.getElementById(`eq_h_${i+1}`).value = e.h || 0;
                document.getElementById(`eq_d_${i+1}`).value = e.d || 0;
                document.getElementById(`eq_s_${i+1}`).value = e.s || 0;
                document.getElementById(`eq_e_${i+1}`).value = e.e || "";
            });
            salvar();
        };
        reader.readAsText(event.target.files[0]);
    }

    function carregar() {
        const salvo = localStorage.getItem('ficha_rpg_v7');
        if(salvo) {
            const s = JSON.parse(salvo);
            xpTotalGlobal = s.xpTotal || 0;
            document.getElementById('xp-input').value = xpTotalGlobal;
            atualizarUI(s); // Carrega campos visuais
            // Reaplica todos os campos manualmente para o UI
            document.getElementById('part-name').value = s.part || "";
            document.getElementById('char-select').value = s.char || "DRUZION";
            document.getElementById('ouro').value = s.ouro || 0;
            document.getElementById('diamante').value = s.diamante || 0;
            document.getElementById('mochila').value = s.mochila || "";
            s.equips.forEach((e, i) => {
                document.getElementById(`eq_n_${i+1}`).value = e.n || "";
                document.getElementById(`eq_h_${i+1}`).value = e.h || 0;
                document.getElementById(`eq_d_${i+1}`).value = e.d || 0;
                document.getElementById(`eq_s_${i+1}`).value = e.s || 0;
                document.getElementById(`eq_e_${i+1}`).value = e.e || "";
            });
            atualizarUI(s);
        } else { salvar(); }
    }

    function resetar() { if(confirm("Deseja apagar tudo?")) { localStorage.clear(); location.reload(); } }
    window.onload = carregar;
</script>
</body>
</html>
